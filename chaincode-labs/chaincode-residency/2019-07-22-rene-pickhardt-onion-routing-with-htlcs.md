---
title: Rene Pickhardt - Onion Routing with HTLCs on the Lightning Network 
Transcript_by: Dulce Villarreal
categories: ['residency']
tags: [‘lightning’, ‘onion routing’]
---


Name: Rene Pickhardt

Topic: Onion Routing with HTLCs on the Lightning Network 

Location: Part of “Hacking the Lightning Network - A protocol to scale Bitcoin” book project

Date: Jan 22, 2019

Video: https://www.youtube.com/watch?v=toarjBSPFqI

Transcript by: Dulce Villarreal 


## Introduction

So let us assume we have a sender on the Lightning Network who wants to send some money. Let's say 300 satoshis to a recipient R, and they're both on the Lightning Network, but they don't have a direct payment channel between them. Since the Lightning Network is a network, the sender might have a channel to a node called N1, and this node might have another channel to a node called N2. This Node N2 might have a channel to R, and we assumed already that all the channels have enough capacity to forward a payment, and I also write down the short channel ID. So we start by creating a message that basically contains the amount that is supposed to be sent to R, and we put this message into an onion envelope, there's actually a little bit more data inside this onion, and it contains public information, which is the key_R. So I want to talk a little bit about this key_R and why it is actually needed. 

Our general goal is to encrypt the message inside this envelope, so we could have used the public key of Node R and the private key of node S, the sender, to do an analytic curve Diffie-Hellman key exchange in order to create a shared secret and encrypt this message. The problem then is that the node that is processing this onion would have to know that the message originated from the sender, the sender would have to reveal its key, this highly decreases the anonymity of the payment since every node on the route would see that the payment originated from S. So, what S does instead is it creates an ephemeral key or a temporal key that it uses for this particular layer of the onion, so in our case for the Node R. So. he uses this ephemeral key to do a Diffie-Hellman key exchange with Node R and it still has to reveal the public key that was being used to our, and it does so by putting it exactly on this message envelope here. Otherwise, R cannot do its side of the computation of the Diffie-Hellman key exchange in order to produce the shared secret. 

If that was too quick for you and you're not familiar with elliptic curve Diffie-Hellman key exchanges. I highly encourage you to subscribe to my channel because I plan to explain this in a separate video in more detail later. 
So then we extend our onion by creating another message which again has the amount 300, but it has a short channel id of 452, and we put this in a new envelope, and this new envelope is sealed, and again it needs to have a key, which is the key that is being used for Node N2. 
Now, this message again is getting extended since the Node N2 wants to have some routing fees; the amount now will be 301 satoshis, so Node 2 will earn 1 satoshi in routing fees, and the short channel id is 74, which is the channel between N1 and N2. So, this again is put into an envelope, and the envelope gets a public information which is the key that is being used for Diffie-Hellman key exchange with Node N1 and they extend it again by message 303 satoshis in this time, and there is a short channel id attached to it, which is 357. So now we use a red envelope. Red envelopes are the ones that are happening on a different part of the Bolt specification, which is Bolt #8 the transport layer and also, in this case, Bolt #2 which is the peer protocol and on this envelope, we put the payment hash, kind of like a stamp, on it. We say what kind of message it should be, so it should be an update add HTLC message. There's a little bit more metadata to it, I left this out in order to make stuff a little bit simpler, and we put inside this update add HTLC message, the onion package, and we send this peer to peer message over the transport layer that is defined Bolt #8 from the sender to Node 1. 

So now N1 receives the message, opens it, and sees. Oh! there's supposed to be an amount of 303 sent to me on this channel. So, basically, S and N1 set up an HTLC in their commitment transaction. An HTLC is basically a conditional payment, where the condition is that the preimage to the payment hash is known, so the payment hash from the envelope is part of the HTLC that is being set up. 
Don't forget to subscribe to my channel as in future videos I will certainly explain more about the construction of payment channels and how HTLCs are particular outputs of the commitment transactions that are being used in the construction of a payment channel. And then there's also the encrypted envelope; since this envelope uses the key N1 the Node N1 can decrypt the message, and it sees an amount that it's supposed to forward, which is 301 satoshis over a channel that it's supposed to forward and it sees another sealed envelope which it can't open because it doesn't have access to the note. Now, another HTLC is set up; this is again being done by putting this information into the updated add HTLC message on the transport layer. Where it sends to Node 2, and Node 2 basically does the same, it opens this, it looks at the message and sees; Yes perfect, this is my HTLC.  So it negotiates the HTLC with N1, it decrypts its envelope and it sees Oh I'm supposed to forward 300 satoshis to the short channel id 452, so a new HTLC is set up with the amount of 300 and again in order to do this of course there needs to be send an update add HTLC message, so this message goes from N2 to R and R now opens the envelope and it checks that the HTLC is correct. So it decrypts the onion and R sees that it has received 300 satoshis. And in particular it knows that it shouldn't forward this onion any more, because there's no other envelope inside, there is some metadata which, I omitted that really shows that this was the message for R and of course R can only receive 300 satoshis if it knows the preimage to this payment hash that it originally created, and now we have to see how we can settle the preimage. So, let's assume the preimage for this payment hash was 45a3b7 and we put the preimage into another Bolt #2 message the update fulfill HTLC message, and this is being sent from R to N2. R can safely release this preimage, because the HTLC is set up in case that a new channel state is not being negotiated between N2 and R, R can force close the channel and settle the HTLC onchain. Then of course N2 takes the preimage and also wants to claim the funds, because now it has paid R so it wants to get reimbursed. It sends the preimage via an update fulfill HTLC message back to N1, and N1 does the same by claiming the money from S who was supposed to do the original payment. 

S can basically check that this preimage really computes the payment hash which any of the notes should have done. So at this point we see that all the HTLCs are being set up. They are being set up in the direction from S to N1 to N2 to R. The onion is encrypted in the other way around. So it starts with the message for R and then comes to next layer with the message for N2, the next layer with a message for N1, and then we already see that N1 received 303 satoshis, but only forwarded 301 which N2 received and N2 only forwarded 300 satoshis, which means that N1 collected a fee of 2 satoshis and N2 collected a fee of 1 satoshi. The sender needs to pay a little bit more, so the sender paid 303 satoshis with a total fee of 3 satoshis. 

Let me explain a few things about the privacy of the Lightning Network. If we go back to the stage of the video where you can see that N2 already has decrypted its onion message and it's about to forward another onion to R. The interesting thing is that N2 doesn't know that the onion really originated from S, it cannot know this, and also what it cannot know is that the onion that is being forwarded to R is really only going to R and not being forwarded again. One thing, that I omitted in this video is that the onion messages are always padded with a little bit of random junk data, so, that at all levels of the routing process, the messages have the same size, and nobody can really see anything. This privacy comes at some cost because due to this privacy and the fact that the channel balance is also not public information, the source was creating the onion packages just has to select the route, and it could happen that a payment channel doesn't have enough capacity in order to forward the payment. This is something that the critics will always use as a reason to explain to you why the Lightning Network must fail. In my opinion, the routing becomes more and more stable as the Lightning Network grows, so over the last year, the routing success was just in my personal usage experience growing and growing, so I would not consider this to be a really big issue. Also, I want to emphasize that once the chain of HTLCs is set up, everything is enforceable on the blockchain and before the chain of HTLCs is set up, nobody really takes a risk, so this is really a secure way of doing a payment. But one thing that you might have already realized is the fact that this entire process is a little bit complex. If you ask me, it it's really hard to extract this information from the white paper, because the white paper pretty much only describes the cryptography of setting up a payment channel and creating HTLCs, it doesn't really talk about the transport layer protocol and about the peer protocol. Whereas, when you look at the Bolts you can read the Bolt #4 which is the onion routing bolt that basically describes the sphinx mix format that is being used, which I kind of neglected here, but I really was creating the video I also had to look at the Bolt #2, Bolt #3, Bolt #5, Bolt #8 and technically also at Bolt #7. So all the Bolts also very much interacting with each other, which also makes them hard to learn from them. If you are new to this channel, you might know that this video was made possible by this amazing community of bitcoin enthusiasts, who supported my first fundraiser that I could buy the document camera that I used in this video. Thank you so much for all this almost 30 people who supported this first fundraiser. Therefore, I want to encourage you to support my educational activities even further because a camera is really great to record videos, but I also need time which, I can't use to earn money otherwise, this video, for example, took almost 2 days to create besides the fact that I had to read all the Bolts and I had to understand the Lightning Network in the first place. You might know, that I'm trying to create an educational book about the Lightning Network. This book effort goes hand in hand with creating more videos like this. So, I would encourage you to check out my Tallycoin page, where you can donate with bitcoin or with a Lightning Network payment. For those people who prefer to pay fiat and get rid of the fiat money, I also have set up a Patreon page. This would really help me a lot and motivate me a lot if we could fill up my fundraiser in this month to at least reach one bitcoin in order for me to continue creating this kind of content.

